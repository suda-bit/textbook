<!DOCTYPE html>
<!-- Finalized (コード整備のみ / 内容不変) on 2026-01-19 03:19 -->
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>北海学園札幌高校 3年 教科書シミュレーター</title>
<style>
:root{--brand:#0a3a7a;--brand-2:#0f4c9a;--gold:#d4af37;--bg:#f6f8fc;--panel:#ffffff;--ink:#1b2330;--muted:#6b7280;--ok:#137333;--warn:#b26b00;--err:#b00020;--ring:0 0 0 3px rgba(13,110,253,.25);--shadow:0 10px 30px rgba(10,58,122,.12);--radius:14px}
@media (prefers-color-scheme: dark){:root{--bg:#0f1724;--panel:#0f1b2f;--ink:#e8eefb;--muted:#97a2b9;--shadow:0 12px 28px rgba(0,0,0,.5)}}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(800px 400px at -10% -10%,#e9f1ff,transparent 55%),radial-gradient(900px 400px at 110% 0%,#fff3d6,transparent 55%),linear-gradient(180deg,#ffffff,var(--bg));color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,'Hiragino Sans','Yu Gothic',sans-serif}
.container{max-width:1120px;margin:clamp(10px,3vw,28px) auto;padding:clamp(10px,2vw,20px)}
.visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;padding:0;border:0;clip:rect(0 0 0 0);overflow:hidden}
.app-header{display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,#ffffffb5,#ffffff40);border:1px solid #ffffff70;backdrop-filter:blur(10px);padding:14px 18px;border-radius:16px;box-shadow:var(--shadow);position:sticky;top:10px;z-index:5}
.logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#fff;border:2px solid var(--gold);overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.title{margin:0;font-weight:800;letter-spacing:.02em;color:var(--brand);font-size:clamp(1.15rem,2.2vw,1.6rem)}
.stepper{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.step-pill{flex:1 1 160px;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:#fff;border:1px solid #e6ebf5;color:#667085;font-weight:700;box-shadow:0 3px 12px rgba(0,0,0,.05)}
.step-pill .dot{width:24px;height:24px;border-radius:999px;display:grid;place-items:center;background:#eef2f8;color:#304056;font-weight:800;font-size:.9rem}
.step-pill[aria-current="step"]{color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent}
.step-pill[aria-current="step"] .dot{background:#ffffff33;color:#fff}
.step-pill.done{background:#0a3a7a10;color:var(--brand);border-color:#0a3a7a30}
.main{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
@media (max-width:960px){.main{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid #ffffff40;border-radius:var(--radius);box-shadow:var(--shadow)}
.content-panel{padding:clamp(14px,2.2vw,22px)}
.preview-panel{position:sticky;top:86px;align-self:start}
.preview-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e9eef7;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-radius:var(--radius) var(--radius) 0 0}
.preview-body{padding:12px 16px;max-height:70vh;overflow:auto}
.badge{background:#ffffff25;border:1px solid #ffffff55;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.82rem}
.section{margin-bottom:16px}
.section h3{margin:0 0 6px;color:var(--brand)}
.help{color:var(--muted);font-size:.9rem;margin:-2px 0 8px}
.btn-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
button.selector{position:relative;padding:14px;border-radius:12px;border:1px solid #e7ecf6;background:#fff;text-align:left;font-weight:800;color:#2c3446;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease;box-shadow:0 6px 16px rgba(10,58,122,.08)}
button.selector .hint{display:block;font-size:.82rem;color:var(--muted);font-weight:600;margin-top:4px}
button.selector:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(10,58,122,.16),var(--ring)}
button.selector[aria-pressed="true"],button.selector:focus{outline:3px solid #0a3a7a66}
.chk-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.chk{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid #e7ecf6;border-radius:12px;padding:10px}
.chk input{transform:scale(1.2)}
.table{width:100%;border-collapse:collapse;background:#fff}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #eef2f8;font-size:.92rem}
.table th{background:#f9fbff;color:#445;text-align:left}
.table td.r{text-align:right;white-space:nowrap}
.total-row{display:flex;justify-content:flex-end;gap:12px;padding:12px 16px;border-top:2px solid #f2e9c9;background:#fffaf2;color:#7a5600;font-weight:800}
.note{font-size:.88rem;color:var(--muted)}
.warning{color:var(--warn)}
.ok{color:var(--ok)}
.status-pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:.8rem;border:1px solid #e7ecf6;background:#fff}
.status-pill.ok{border-color:#cfe8d8;color:var(--ok);background:#f0fbf4}
.status-pill.warn{border-color:#f1e0c4;color:var(--warn);background:#fff8eb}
.skeleton{position:relative;overflow:hidden;background:#eef2f8}
.skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);animation:shimmer 1.2s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}
.hidden{display:none!important}
.spacer{height:8px}
.actions{display:flex;gap:10px;margin-top:10px}
.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
.primary:disabled{opacity:.6}
.secondary{background:#eef2f8;color:#304056;border:none;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
@media print{.app-header,.stepper,.preview-panel,.actions{display:none!important}.panel{box-shadow:none;border:none}.content-panel{padding:0}#print-header{display:block!important;border-bottom:2px solid #e5e7eb;margin-bottom:12px;padding-bottom:8px}}
#print-header{display:none}
#print-header h2{margin:0 0 4px}
#print-header .meta{font-size:.9rem;color:#4a5568}
#pill-grade, #step-grade { display:none !important; }

.book-list{margin:6px 0 0;color:var(--muted);font-size:.82rem;line-height:1.4}
.book-list li{list-style:disc;margin-left:1.2em}
.opt-card{display:flex;flex-direction:column;gap:6px}
</style>
</head>
<body>
<div class="container">
  <header class="app-header panel" role="banner">
    <div aria-hidden="true" class="logo">./00学園札幌校章カラー.bmp</div>
    <div>
      <h1 class="title">北海学園札幌高校 3年 教科書シミュレーター</h1>
    </div>
  </header>

  <nav aria-label="進行状況" class="stepper">
    <div class="step-pill hidden" id="pill-grade"><span class="dot">1</span>学年</div>
    <div aria-current="step" class="step-pill" id="pill-course"><span class="dot">1</span>コース</div>
    <div class="step-pill" id="pill-track"><span class="dot">2</span>進路</div>
    <div class="step-pill" id="pill-elective"><span class="dot">3</span>選択</div>
    <div class="step-pill" id="pill-result"><span class="dot">4</span>確認</div>
  </nav>

  <div class="main">
    <main aria-live="polite" class="panel content-panel" id="content">
      <div aria-hidden="true" id="print-header">
        <h2>教科書購入控え</h2>
        <div class="meta" id="print-meta">学年・コース・文理／作成日</div>
      </div>

      <section aria-labelledby="g-title" class="step hidden" id="step-grade">
        <h2 class="visually-hidden" id="g-title">学年</h2>
      </section>

      <section aria-labelledby="c-title" class="step" id="step-course">
        <h2 class="visually-hidden" id="c-title">コース</h2>
        <div aria-label="コースを選択" class="section" role="radiogroup">
          <h3>コースを選択 <span class="status-pill warn" id="st-course">未選択</span></h3>
          <div class="btn-grid" id="course-btns"></div>
          <div class="actions"><button class="secondary" onclick="restartG3()">リセット</button></div>
        </div>
      </section>

      <section aria-labelledby="t-title" class="step hidden" id="step-track">
        <h2 class="visually-hidden" id="t-title">進路</h2>
        <div aria-label="進路を選択" class="section" role="radiogroup">
          <h3>進路（文理）を選択 <span class="status-pill warn" id="st-track">未選択</span></h3>
          <div class="btn-grid">
            <button aria-checked="false" aria-pressed="false" class="selector" onclick="pickTrack('文系', this)" role="radio">文系</button>
            <button aria-checked="false" aria-pressed="false" class="selector" onclick="pickTrack('理系', this)" role="radio">理系</button>
          </div>
          <div class="actions"><button class="secondary" onclick="goStep('course')">戻る</button></div>
        </div>
      </section>

      <section aria-labelledby="e-title" class="step hidden" id="step-elective">
        <h2 class="visually-hidden" id="e-title">選択</h2>
        <div class="section skeleton" id="elective-skeleton" style="height:120px;border-radius:12px"></div>
        <div aria-live="polite" class="hidden" id="elective-sections"></div>
        <div class="actions">
          <button class="secondary" onclick="goStep('track')">戻る</button>
          <button class="primary" disabled id="btn-final" onclick="finalize()">選択を確定して結果へ</button>
        </div>
      </section>

      <section aria-labelledby="r-title" class="step hidden" id="step-result">
        <h2 class="visually-hidden" id="r-title">結果</h2>
        <div class="section">
          <h3>結果 <span class="status-pill ok" id="st-result">作成済み</span></h3>
          <div class="note">必修・選択を合算しています。価格未登録は¥0（※要確認）で表示します。</div>
          <div class="spacer"></div>
          <div class="panel">
            <div class="preview-header">
              <div id="res-info">集計</div>
              <span class="badge" id="res-count">0 点</span>
            </div>
            <div class="preview-body">
              <table class="table">
                <thead><tr><th>教材名</th><th class="r">定価</th></tr></thead>
                <tbody id="res-list"></tbody>
              </table>
              <div class="total-row"><span>合計金額:</span><strong id="res-total">¥0</strong></div>
            </div>
          </div>
          <div class="actions"><button class="primary" id="btn-vendor" onclick="openVendorSheet()">教科書購入表を表示</button><button class="secondary" onclick="restartG3()">最初に戻る</button></div>
        </div>
      </section>
    </main>

    <aside aria-label="選択状況サマリー" class="panel preview-panel">
      <div class="preview-header"><strong>選択状況</strong><span class="badge" id="pv-count">0 点</span></div>
      <div class="preview-body">
        <div class="note">価格未登録は ¥0（※要確認）として表示します。</div>
        <div class="spacer"></div>
        <table class="table">
          <thead><tr><th>教材名</th><th class="r">概算</th></tr></thead>
          <tbody id="pv-list"></tbody>
        </table>
        <div class="total-row"><span>概算合計:</span><strong id="pv-total">¥0</strong></div>
        <div class="spacer"></div>
        <div class="note warning" id="pv-missing">必須の選択数を満たしていない項目があります。</div>
      </div>
    </aside>
  </div>
</div>

<div aria-live="polite" class="visually-hidden" id="live-region"></div>

<script>
const DB_G3 = {"data": {"courses": {"特進": {"must": [{"n": "数学B Standard","p": 779},{"n": "Vivid English Communication　Ⅲ","p": 724},{"n": "APPLAUSE ENGLISH LOGIC AND EXPRESSION Ⅲ","p": 556},{"n": "2026共通テスト対策実力養成重要問題演習 現代文","p": 1280},{"n": "論理的に読む　論読　現代文2　要約シート付","p": 700},{"n": "2026共通テスト対策実力養成重要問題演習 古典","p": 1060},{"n": "読み解く古典2　ノート付","p": 721},{"n": "2026 共通テスト対策【実力完成】直前演習 国語　(7月刊行予定)★","p": 1280},{"n": "新精選古典文法実践ノート","p": 350},{"n": "新版完全征服　頻出　入試漢字2800","p": 880},{"n": "読解を深める　現代文単語　評論・小説","p": 1012},{"n": "攻略！共通テスト　Pick Up　数学Ⅰ+A／Ⅱ+B+C","p": 1100},{"n": "新体力テストオンライン　ライト","p": 190},{"n": "2027共通テスト対策【実力養成】重要問題演習英語（リーディング）","p": 1060},{"n": "2027共通テスト対策【実力完成】直前演習英語(リスニング)30minutes×7　（５月刊行予定）★","p": 1161},{"n": "2027共通テスト英語模擬演習40min. (本冊も解答もどちらもバラ希望)  (9月頃発売日未定)★","p": 979},{"n": "Starting Line Listening","p": 979},{"n": "合　計　冊","p": 0}],"sections": [{"title": "Excel選択データ","options": [{"name": "fromExcel","books": [{"n": "新課程大学入試共通テスト対策　チェック＆演習　生物基礎","p": 1584},{"n": "ニューステップアップ生物基礎","p": 770},{"n": "新課程大学入試共通テスト対策　チェック＆演習　物理","p": 1001},{"n": "新課程大学入試共通テスト対策　チェック＆演習　生物","p": 990},{"n": "政治・経済","p": 2675},{"n": "政治・経済 要点マスター","p": 1034},{"n": "最新政治・経済資料集2026（デジタル版）","p": 1100},{"n": "テオーリア　最新倫理資料集","p": 990},{"n": "2027実践攻略　公共，倫理　大学入学共通テスト問題集","p": 979},{"n": "数学Ⅲ　Standard","p": 1794},{"n": "WIDE　数学Ⅲ　問題編","p": 680},{"n": "WIDE　数学Ⅲ　解答編","p": 310}]}]}]},"総合進学": {"must": [{"n": "数学B Standard","p": 779},{"n": "Vivid English Communication　Ⅲ","p": 724},{"n": "APPLAUSE ENGLISH LOGIC AND EXPRESSION Ⅲ","p": 556},{"n": "新体力テストオンライン　ライト","p": 190},{"n": "CROSSBEAM 総合問題集S1","p": 638},{"n": "合　計　5冊","p": 2887}],"sections": [{"title": "Excel選択データ","options": [{"name": "fromExcel","books": [{"n": "政治・経済","p": 541},{"n": "政治・経済 要点マスター","p": 1034},{"n": "テオーリア　最新倫理資料集","p": 759},{"n": "倫理　要点マスター","p": 979},{"n": "数学Ⅲ　Standard","p": 702},{"n": "WIDE　数学Ⅲ　問題編","p": 680},{"n": "WIDE　数学Ⅲ　解答編","p": 310},{"n": "新課程　リンク数学演習ⅠA＋ⅡBC(ベクトル)　受験編 a+b+c 新課程","p": 869},{"n": "「論理の力」を育てるシリーズ　論理力ワークノート","p": 2244},{"n": "知識から思考へ　大学入試・小論文ジャンル別キーワード解説　五訂版","p": 583},{"n": "すらすら読める　速読古典Ⅰ","p": 495},{"n": "レッツトライノート　生物基礎","p": 660},{"n": "アニメ中国語　恋する莎莎　CD付　中国語","p": 2915},{"n": "音楽ⅡTutti","p": 354},{"n": "美術2","p": 994}]}]}]},"グローバル": {"must": [{"n": "数学B Standard","p": 779},{"n": "Vivid English Communication　Ⅲ","p": 724},{"n": "APPLAUSE ENGLISH LOGIC AND EXPRESSION Ⅲ","p": 556},{"n": "新課程　リンク数学演習ⅠA＋ⅡBC(ベクトル)　受験編 a+b+c 新課程","p": 869},{"n": "新体力テストオンライン　ライト","p": 190},{"n": "CROSSBEAM 総合問題集S1","p": 638},{"n": "合　計　6冊","p": 3756}],"sections": [{"title": "Excel選択データ","options": [{"name": "fromExcel","books": [{"n": "政治・経済","p": 541},{"n": "政治・経済 要点マスター","p": 1034},{"n": "テオーリア　最新倫理資料集","p": 759},{"n": "倫理　要点マスター","p": 979},{"n": "「論理の力」を育てるシリーズ　論理力ワークノート","p": 2244},{"n": "知識から思考へ　大学入試・小論文ジャンル別キーワード解説　五訂版","p": 583},{"n": "すらすら読める　速読古典Ⅰ","p": 495},{"n": "レッツトライノート　生物基礎","p": 660}]}]}]},"メディカルプレップ": {"must": [{"n": "数学B Standard","p": 779},{"n": "Vivid English Communication　Ⅲ","p": 724},{"n": "APPLAUSE ENGLISH LOGIC AND EXPRESSION Ⅲ","p": 556},{"n": "10日あればいい！　2026入試　短期集中ゼミ　看護・医療系のための数学Ⅰ・A\n(2026年7月刊行予定)★","p": 770},{"n": "新体力テストオンライン　ライト","p": 190},{"n": "CROSSBEAM 総合問題集S1","p": 638},{"n": "合　計6冊","p": 3657}],"sections": [{"title": "Excel選択データ","options": [{"name": "fromExcel","books": [{"n": "政治・経済","p": 541},{"n": "政治・経済 要点マスター","p": 1034},{"n": "テオーリア　最新倫理資料集","p": 759},{"n": "倫理　要点マスター","p": 979},{"n": "「論理の力」を育てるシリーズ　論理力ワークノート","p": 2354},{"n": "知識から思考へ　大学入試・小論文ジャンル別キーワード解説　五訂版","p": 583},{"n": "すらすら読める　速読古典Ⅰ","p": 495},{"n": "ニューステップアップ生物基礎","p": 770}]}]}]}}}};

// --- 教材データ差し替え用ヘルパー ---
function pickBooksByKeywords(keywords){
  try{
    const courses = (DB_G3&&DB_G3.data&&DB_G3.data.courses)? DB_G3.data.courses : {};
    const res=[];
    for(const cname in courses){
      const d=courses[cname]||{};
      (d.must||[]).forEach(b=>{ if(keywords.some(k=> (b.n||'').includes(k))) res.push(b); });
      (d.sections||[]).forEach(sec=>{ (sec.options||[]).forEach(o=>{ (o.books||[]).forEach(b=>{ if(keywords.some(k=> (b.n||'').includes(k))) res.push(b); }); }); });
    }
    return res;
  }catch(e){ return []; }
}
function ensure(list, name){ return (list && list.length)? list : [{n:`【教材未登録】${name}`, p:0, note:'※要確認'}]; }

const selections = { grade:'', course:'', track:'', choices:{} };
const $ = s => document.querySelector(s);
const stepEls = { grade:$('#step-grade'), course:$('#step-course'), track:$('#step-track'), elective:$('#step-elective'), result:$('#step-result') };
const pillEls = { grade:$('#pill-grade'), course:$('#pill-course'), track:$('#pill-track'), elective:$('#pill-elective'), result:$('#pill-result') };
const statusEls = { grade:null, course:$('#st-course'), track:$('#st-track') };

function setStepper(state){
  for(const k in pillEls){ const p=pillEls[k]; if(!p) continue; p.removeAttribute('aria-current'); p.classList.toggle('done', false); }
  if(pillEls[state]) { pillEls[state].setAttribute('aria-current','step'); }
  const order=['course','track','elective','result'];
  for(const k of order){ if(k===state) break; if(pillEls[k]) pillEls[k].classList.add('done'); }
}

function goStep(id){
  Object.entries(stepEls).forEach(([k,el])=>{
    if(!el) return;
    if('step-'+id===el.id) el.classList.remove('hidden');
    else el.classList.add('hidden');
  });
  setStepper(id);
  updatePreview();
  try { var aside = document.querySelector('.preview-panel'); if (aside) { aside.classList.toggle('hidden', id==='result'); } } catch(e){}
  announce(`ステップを${id}に移動しました。`);
}

function announce(msg){ const live=$('#live-region'); if(!live) return; live.textContent=''; setTimeout(()=> live.textContent=msg, 10); }

const baseDB = {
 '3': { common: [
 {n:"数学B Standard", p:759},{n:"Vivid English Comm III", p:706},
 {n:"Logic & Expression III", p:542},{n:"数学B ワークWIDE", p:490}
 ] }
};

function markPressed(btn){
  if(!btn) return;
  const sibs=btn.parentElement.querySelectorAll('button.selector');
  sibs.forEach(b=>{b.setAttribute('aria-pressed','false'); b.setAttribute('aria-checked','false');});
  btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-checked','true');
}

function buildCourseButtonsForG3(){
  const courses=['特進','グローバル','メディカルプレップ','総合進学'];
  const box=$('#course-btns');
  box.innerHTML='';
  courses.forEach(c=>{
    const b=document.createElement('button');
    b.className='selector';
    b.textContent = `${c}コース`;
    b.setAttribute('role','radio');
    b.setAttribute('aria-checked','false');
    b.onclick=()=>{ markPressed(b); pickCourse(c); };
    box.appendChild(b);
  });
}

function pickCourse(c){
  selections.course=c;
  selections.choices={};
  if(statusEls.course){ statusEls.course.className='status-pill ok'; statusEls.course.textContent='選択済み'; }
  const needTrack = true;
  if(needTrack){ goStep('track'); }
  else { buildElectives(); goStep('elective'); }
}

function pickTrack(t, btn){
  selections.track=t;
  markPressed(btn);
  if(statusEls.track){ statusEls.track.className='status-pill ok'; statusEls.track.textContent='選択済み'; }
  buildElectives(); goStep('elective');
}

function section(title){ const wrap=document.createElement('div'); wrap.className='section'; const h=document.createElement('h3'); h.textContent=title; wrap.appendChild(h); return wrap; }
function help(text){ const d=document.createElement('div'); d.className='help'; d.textContent=text; return d; }

function makeSingleChoiceSection(title, options, key){
  const sec=section(title);
  const list=document.createElement('div'); list.className='btn-grid';
  const badge=document.createElement('span'); badge.className='status-pill warn'; badge.textContent='未選択';
  sec.querySelector('h3').appendChild(document.createTextNode(' '));
  sec.querySelector('h3').appendChild(badge);
  options.forEach(opt=>{
    const b=document.createElement('button'); b.className='selector';
    b.innerHTML=`${opt.name} <span class='hint'>${opt.books.length}冊</span>`;
    b.setAttribute('role','radio'); b.setAttribute('aria-checked','false');
    b.onclick=()=>{
      selections.choices[key]=opt;
      list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false'); x.setAttribute('aria-checked','false');});
      b.setAttribute('aria-pressed','true'); b.setAttribute('aria-checked','true');
      badge.className='status-pill ok'; badge.textContent='選択済み';
      updatePreview(); updateFinalizeState();
    };
    list.appendChild(b);
  });
  sec.appendChild(list); return sec;
}

function makeRequiredSingleFromOptions(title, options, key){
 const sec = section(title + '（1科目）');
 const list = document.createElement('div'); list.className = 'btn-grid';
 const badge = document.createElement('span'); badge.className='status-pill warn'; badge.textContent='未選択';
 sec.querySelector('h3').appendChild(document.createTextNode(' '));
 sec.querySelector('h3').appendChild(badge);
 selections.choices[key] = [];
 options.forEach(opt=>{
   const b = document.createElement('button');
   b.className='selector';
   b.innerHTML = `${opt.name} <span class='hint'>${opt.books.length}冊</span>`;
   b.setAttribute('role','radio');
   b.setAttribute('aria-checked','false');
   b.onclick = ()=>{
     selections.choices[key] = [opt];
     list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false');x.setAttribute('aria-checked','false');});
     b.setAttribute('aria-pressed','true');
     b.setAttribute('aria-checked','true');
     badge.className='status-pill ok';
     badge.textContent='選択済み';
     updatePreview();
     updateFinalizeState();
   };
   list.appendChild(b);
 });
 sec.appendChild(list);
 sec.dataset.require = 1;
 sec.dataset.key = key;
 return sec;
}

function makeMultiChoiceSection(title, options, key, requireCount){
  const sec=section(`${title}（${requireCount}科目選択）`);
  const grid=document.createElement('div'); grid.className='chk-grid';
  selections.choices[key]=selections.choices[key]||[];
  const badge=document.createElement('span'); badge.className='status-pill warn'; badge.textContent=`あと${requireCount}科目`;
  sec.querySelector('h3').appendChild(document.createTextNode(' '));
  sec.querySelector('h3').appendChild(badge);
  function updateBadge(){
    const picked=(selections.choices[key]||[]).length;
    const remain=requireCount-picked;
    if(remain<=0){ badge.className='status-pill ok'; badge.textContent='要件クリア'; }
    else { badge.className='status-pill warn'; badge.textContent=`あと${remain}科目`; }
    updatePreview(); updateFinalizeState();
  }
  options.forEach(opt=>{
    const row=document.createElement('label'); row.className='chk';
    const cb=document.createElement('input'); cb.type='checkbox';
    cb.onchange=()=>{
      const arr=selections.choices[key];
      if(cb.checked){ if(!arr.find(o=>o.name===opt.name)) arr.push(opt); }
      else { const i=arr.findIndex(o=>o.name===opt.name); if(i>=0) arr.splice(i,1); }
      updateBadge();
    };
    const span=document.createElement('span'); span.textContent=`${opt.name}（${opt.books.length}冊）`;
    row.appendChild(cb); row.appendChild(span); grid.appendChild(row);
  });
  sec.appendChild(grid);
  sec.dataset.require=requireCount; sec.dataset.key=key;
  return sec;
}

function autoAddSection(title, books){
  const sec=section(title);
  sec.appendChild(help('自動的に合計へ含まれます。'));
  const table=document.createElement('table'); table.className='table'; const tb=document.createElement('tbody');
  books.forEach(b=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${b.n}${b.note? ' <span class=\"warning\">'+b.note+'</span>':''}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
  table.appendChild(tb); sec.appendChild(table);
  selections.choices['auto_'+title]={name:title, books:books}; return sec;
}



// ==== Helpers & rule-based builders ====
function allBooksForCourse(course){
  const d = (DB_G3&&DB_G3.data&&DB_G3.data.courses&&DB_G3.data.courses[course])? DB_G3.data.courses[course]:{};
  const pool=[]; (d.must||[]).forEach(b=>pool.push(b));
  (((d.sections||[])[0]||{}).options||[]).forEach(o=>{ (o.books||[]).forEach(b=>pool.push(b)); });
  return pool;
}
function findFirst(pool, includes){ return pool.find(b=> includes.every(k=> (b.n||'').includes(k))); }
function findAll(pool, anyKeywords){ return pool.filter(b=> anyKeywords.some(k=> (b.n||'').includes(k))); }
function pickOrPlaceholder(book, label, price){ return book? [book] : [{n:`【教材未登録】${label}`, p:(typeof price==='number'? price:0), note:'※要確認'}]; }
function ensureCount(list, count, label){ const out=[...list]; while(out.length<count){ out.push({n:`【教材未登録】${label}`, p:0, note:'※要確認'}); } return out.slice(0,count); }
function escapeHTML(s){
  const div = document.createElement('div');
  div.textContent = s == null ? '' : String(s);
  return div.innerHTML;
}
function booksToListHTML(books){ try{ const items=(books||[]).map(b=>`<li>${escapeHTML(b.n||'')}${(b.p!=null)?`（¥${(b.p||0).toLocaleString()}）`:''}</li>`).join(''); return `<ul class="book-list">${items}</ul>`; }catch(e){ return ''; } }

function buildEthicsSet(course){ const p=allBooksForCourse(course); const text=findFirst(p,['倫理リンリ']); const y=findFirst(p,['倫理','要点']); let s=findFirst(p,['倫理','資料集']); if(!s) s=findFirst(p,['最新倫理資料集']); let list=[]; list=list.concat(pickOrPlaceholder(text,'倫理')); list=list.concat(pickOrPlaceholder(y,'倫理 要点マスター')); list=list.concat(pickOrPlaceholder(s,'最新倫理資料集')); return ensureCount(list,3,'倫理'); }
function buildPoliticsSet(course, wantCount){ const p=allBooksForCourse(course); const t=findFirst(p,['政治・経済']); const y=findFirst(p,['政治・経済','要点']); const s=findFirst(p,['政治・経済','資料集']); let list=[]; list=list.concat(pickOrPlaceholder(t,'政治・経済')); list=list.concat(pickOrPlaceholder(y,'政治・経済 要点マスター')); if(wantCount===3){ list=list.concat(pickOrPlaceholder(s,'最新政治・経済資料集')); } return ensureCount(list, wantCount, '政治・経済'); }
function buildMathIIISet(course){ const p=allBooksForCourse(course); let std=findFirst(p,['数学Ⅲ','Standard']); const q=findFirst(p,['WIDE','数学Ⅲ','問題']); const a=findFirst(p,['WIDE','数学Ⅲ','解答']); if(std && std.p>1000 && q && a){ std={n:'数学Ⅲ Standard', p:804}; } return [].concat(pickOrPlaceholder(std,'数学Ⅲ Standard',804), pickOrPlaceholder(q,'WIDE 数学Ⅲ 問題編',680), pickOrPlaceholder(a,'WIDE 数学Ⅲ 解答編',310)); }
function buildMathExploreSet(course){ const m=findFirst(allBooksForCourse(course),['リンク数学演習']); return pickOrPlaceholder(m,'リンク数学演習',869); }
function buildJpExprSet(course){ const p=allBooksForCourse(course); const a=findFirst(p,['論理力ワークノート']); const b=findFirst(p,['小論文ジャンル別']); const c=findFirst(p,['速読古典']); return [].concat(pickOrPlaceholder(a,'論理力ワークノート',506), pickOrPlaceholder(b,'小論文ジャンル別キーワード',583), pickOrPlaceholder(c,'速読古典Ⅰ',495)); }
function buildChemSet(course){ const ch=findAll(allBooksForCourse(course),['化学']).filter(b=> !(b.n||'').includes('基礎')); return ch.length? ch : [{n:'【教材未登録】化学', p:0, note:'※要確認'}]; }
function buildPhysSet(course){ const ph=findAll(allBooksForCourse(course),['物理']); return ph.length? ph : [{n:'【教材未登録】物理', p:0, note:'※要確認'}]; }
function buildBioSet(course){ const bi=findAll(allBooksForCourse(course),['生物']).filter(b=> !(b.n||'').includes('基礎') || (b.n||'').includes('生物基礎')); return bi.length? bi : [{n:'【教材未登録】生物', p:0, note:'※要確認'}]; }
function buildChemExploreSet(course){ return []; }
function buildBioExploreSet(course){ const e=findAll(allBooksForCourse(course),['生物基礎','生物探究','ニューステップアップ生物基礎','レッツトライノート','チェック＆演習 生物']); return e.length? e : [{n:'【教材未登録】生物探究', p:0, note:'※要確認'}]; }
function buildChineseSet(course){ const zh=findFirst(allBooksForCourse(course),['中国語','アニメ中国語']); return pickOrPlaceholder(zh,'中国語',0); }
function buildKoreanSet(course){ const ko=findFirst(allBooksForCourse(course),['韓国語']); return pickOrPlaceholder(ko,'韓国語',0); }
function buildArtsOptions(course){ const music=findFirst(allBooksForCourse(course),['音楽Ⅱ','Tutti']); const art=findFirst(allBooksForCourse(course),['美術2','美術Ⅱ']); return [ {name:'音楽Ⅱ', books: pickOrPlaceholder(music,'音楽Ⅱ',0)}, {name:'美術Ⅱ', books: pickOrPlaceholder(art,'美術Ⅱ',0)}, {name:'プレゼンテーション', books:[{n:'【教材未登録】プレゼンテーション', p:0, note:'※要確認'}]}, {name:'プログラミング', books:[{n:'【教材未登録】プログラミング', p:0, note:'※要確認'}]} ]; }

function makeSingleChoiceSection(title, options, key){
  const sec=section(title);
  const list=document.createElement('div'); list.className='btn-grid';
  const badge=document.createElement('span'); badge.className='status-pill warn'; badge.textContent='未選択';
  sec.querySelector('h3').appendChild(document.createTextNode(' '));
  sec.querySelector('h3').appendChild(badge);
  options.forEach(opt=>{
    const wrap=document.createElement('div'); wrap.className='opt-card';
    const b=document.createElement('button'); b.className='selector';
    b.innerHTML=`${opt.name} <span class='hint'>${opt.books.length}冊</span>`; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false');
    b.onclick=()=>{ selections.choices[key]=opt; list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false'); x.setAttribute('aria-checked','false');}); b.setAttribute('aria-pressed','true'); b.setAttribute('aria-checked','true'); badge.className='status-pill ok'; badge.textContent='選択済み'; updatePreview(); updateFinalizeState(); };
    wrap.appendChild(b);
    const listHTML=booksToListHTML(opt.books); if(listHTML){ const div=document.createElement('div'); div.innerHTML=listHTML; wrap.appendChild(div.firstChild); }
    list.appendChild(wrap);
  });
  sec.appendChild(list); return sec;
}

function makeRequiredSingleFromOptions(title, options, key){
  const sec = section(title + '（1科目）');
  const list = document.createElement('div'); list.className = 'btn-grid';
  const badge = document.createElement('span'); badge.className='status-pill warn'; badge.textContent='未選択';
  sec.querySelector('h3').appendChild(document.createTextNode(' '));
  sec.querySelector('h3').appendChild(badge);
  selections.choices[key] = [];
  options.forEach(opt=>{
    const wrap=document.createElement('div'); wrap.className='opt-card';
    const b = document.createElement('button'); b.className='selector'; b.innerHTML = `${opt.name} <span class='hint'>${opt.books.length}冊</span>`; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false');
    b.onclick = ()=>{ selections.choices[key] = [opt]; list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false');x.setAttribute('aria-checked','false');}); b.setAttribute('aria-pressed','true'); b.setAttribute('aria-checked','true'); badge.className='status-pill ok'; badge.textContent='選択済み'; updatePreview(); updateFinalizeState(); };
    wrap.appendChild(b);
    const listHTML=booksToListHTML(opt.books); if(listHTML){ const div=document.createElement('div'); div.innerHTML=listHTML; wrap.appendChild(div.firstChild); }
    list.appendChild(wrap);
  });
  sec.appendChild(list); sec.dataset.require = 1; sec.dataset.key = key; return sec;
}

function buildElectives(){
  $('#elective-skeleton').classList.remove('hidden'); $('#elective-sections').classList.add('hidden');
  setTimeout(()=>{
    const holder=$('#elective-sections'); holder.innerHTML='';
    const course=selections.course; const isSci = selections.track==='理系';
    const dataset=(DB_G3&&DB_G3.data&&DB_G3.data.courses&&DB_G3.data.courses[course])? DB_G3.data.courses[course]:{};

    // 必修
    holder.appendChild(autoAddSection('必修（自動追加）', (dataset.must)||[]));

    // 地歴（特進は世界史除外）
    { const pool=allBooksForCourse(course); const geo=findAll(pool,['地理']).filter(b=> (b.n||'').includes('探究') || (b.n||'').includes('詳説 地理')); const jp=findAll(pool,['日本史']); const world=findAll(pool,['世界史']); const opts=[ {name:'地理探究', books: geo.length? geo : [{n:'【教材未登録】地理探究', p:0, note:'※要確認'}]}, {name:'日本史探究', books: jp.length? jp : [{n:'【教材未登録】日本史探究', p:0, note:'※要確認'}]} ]; if(course!=='特進'){ opts.push({name:'世界史探究', books: world.length? world : [{n:'【教材未登録】世界史探究', p:0, note:'※要確認'}]}); } holder.appendChild(makeSingleChoiceSection('選択I【地歴】', opts, 'g3_geo')); }

    // 倫政（特進以外：倫理3／政経2）
    if(course!=='特進'){ const ethics3=buildEthicsSet(course); const pol2=buildPoliticsSet(course,2); holder.appendChild(makeRequiredSingleFromOptions('選択II【倫政】', [ {name:'倫理', books: ethics3}, {name:'政治・経済', books: pol2} ], 'g3_civ')); }

    if(course==='特進'){
      if(isSci){ const pair=[ {name:'化学・物理', books:[...buildChemSet(course), ...buildPhysSet(course)]}, {name:'化学・生物', books:[...buildChemSet(course), ...buildBioSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択III【理科】', pair, 'g3_sci_pair')); }
      else { const set=[ {name:'化学探究＆生物探究', books:[...buildChemExploreSet(course), ...buildBioExploreSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択II【理科】', set, 'g3_sci_liberal')); const ethics3=buildEthicsSet(course); const pol3=buildPoliticsSet(course,3); holder.appendChild(makeRequiredSingleFromOptions('選択III【倫政】', [ {name:'倫理', books: ethics3}, {name:'政治・経済', books: pol3} ], 'g3_civ_tokushin')); }
      const m3=buildMathIIISet(course), mex=buildMathExploreSet(course); const sec=section('選択IV【数学】'); const list=document.createElement('div'); list.className='btn-grid'; const badge=document.createElement('span'); badge.className='status-pill warn'; badge.textContent='未選択'; sec.querySelector('h3')?.appendChild(document.createTextNode(' ')); sec.querySelector('h3')?.appendChild(badge); [ {name:'数学Ⅲ', books:m3}, {name:'数学探究', books:mex} ].forEach(opt=>{ const b=document.createElement('button'); b.className='selector'; b.innerHTML=`${opt.name} <span class='hint'>${opt.books.length}冊</span>`; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false'); b.onclick=()=>{ selections.choices['g3_math_tokushin']=[opt]; list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false');x.setAttribute('aria-checked','false');}); b.setAttribute('aria-pressed','true'); b.setAttribute('aria-checked','true'); badge.className='status-pill ok'; badge.textContent='選択済み'; updatePreview();}; list.appendChild(b); }); sec.appendChild(list); holder.appendChild(sec);

    }else if(course==='グローバル'){
      if(isSci){ const pair=[ {name:'化学・物理', books:[...buildChemSet(course), ...buildPhysSet(course)]}, {name:'化学・生物', books:[...buildChemSet(course), ...buildBioSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択IV【理科】', pair, 'g3_global_sci_pair')); }
      else { const set=[ {name:'化探＆国表', books:[...buildChemExploreSet(course), ...buildJpExprSet(course)]}, {name:'生探＆国表', books:[...buildBioExploreSet(course), ...buildJpExprSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択III【理科】', set, 'g3_global_sci_set')); const langs=[ {name:'中国語', books: buildChineseSet(course)}, {name:'韓国語', books: buildKoreanSet(course)} ]; holder.appendChild(makeRequiredSingleFromOptions('学校設定教科（語学）', langs, 'g3_global_lang')); }

    }else if(course==='メディカルプレップ'){
      if(isSci){ const pair=[ {name:'化学・物理', books:[...buildChemSet(course), ...buildPhysSet(course)]}, {name:'化学・生物', books:[...buildChemSet(course), ...buildBioSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択IV【理科】', pair, 'g3_med_sci_pair')); }
      else { const set=[ {name:'化探＆国表', books:[...buildChemExploreSet(course), ...buildJpExprSet(course)]}, {name:'生探＆国表', books:[...buildBioExploreSet(course), ...buildJpExprSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択III【理科】', set, 'g3_med_sci_set')); holder.appendChild(autoAddSection('医療情報基礎（文系は必修）', [{n:'【教材未登録】医療情報基礎', p:0, note:'※要確認'}])); }

    }else if(course==='総合進学'){
      const m3=buildMathIIISet(course), mex=buildMathExploreSet(course); const secm=section('選択III【数学】'); const listm=document.createElement('div'); listm.className='btn-grid'; const badgem=document.createElement('span'); badgem.className='status-pill warn'; badgem.textContent='未選択'; secm.querySelector('h3')?.appendChild(document.createTextNode(' ')); secm.querySelector('h3')?.appendChild(badgem); [ {name:'数学Ⅲ', books:m3}, {name:'数学探究', books:mex} ].forEach(opt=>{ const b=document.createElement('button'); b.className='selector'; b.innerHTML=`${opt.name} <span class='hint'>${opt.books.length}冊</span>`; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false'); b.onclick=()=>{ selections.choices['g3_math']=[opt]; listm.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false');x.setAttribute('aria-checked','false');}); b.setAttribute('aria-pressed','true'); b.setAttribute('aria-checked','true'); badgem.className='status-pill ok'; badgem.textContent='選択済み'; updatePreview();}; listm.appendChild(b); }); secm.appendChild(listm); holder.appendChild(secm);
      if(isSci){ const pair=[ {name:'化学・物理', books:[...buildChemSet(course), ...buildPhysSet(course)]}, {name:'化学・生物', books:[...buildChemSet(course), ...buildBioSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択V【理科】', pair, 'g3_soushin_sci_pair')); const addSci=[ {name:'中国語', books: buildChineseSet(course)}, {name:'会計学Ⅱ', books:[{n:'【教材未登録】会計学Ⅱ', p:0, note:'※要確認'}]}, {name:'ライフプランニング', books:[{n:'【教材未登録】ライフプランニング', p:0, note:'※要確認'}]} ]; holder.appendChild(makeRequiredSingleFromOptions('文系追加（1科目）', addSci, 'g3_soushin_extra_sci')); }
      else { const set=[ {name:'化探＆国表', books:[...buildChemExploreSet(course), ...buildJpExprSet(course)]}, {name:'生探＆国表', books:[...buildBioExploreSet(course), ...buildJpExprSet(course)]} ]; holder.appendChild(makeRequiredSingleFromOptions('選択IV【理科】', set, 'g3_soushin_sci_set')); const add=[ {name:'中国語', books: buildChineseSet(course)}, {name:'会計学Ⅱ', books:[{n:'【教材未登録】会計学Ⅱ', p:0, note:'※要確認'}]}, {name:'ライフプランニング', books:[{n:'【教材未登録】ライフプランニング', p:0, note:'※要確認'}]} ]; holder.appendChild(makeRequiredSingleFromOptions('文系追加（1科目）', add, 'g3_soushin_extra')); const arts=buildArtsOptions(course); holder.appendChild(makeRequiredSingleFromOptions('選択VI【芸術】', arts, 'g3_art')); }
    }

    updatePreview(); updateFinalizeState(); $('#elective-skeleton').classList.add('hidden'); $('#elective-sections').classList.remove('hidden');
  }, 450);
}



function aggregateBooks(){
  const g=selections.grade; let books=[];
  if(!g) return [];
  books = books.concat(baseDB[g].common || []);
  if(selections.course==='特進'){
    books.push({n:'特進専用 共テ対策問題集', p:1060});
  }
  Object.values(selections.choices).forEach(sel=>{
    if(!sel) return;
    if(Array.isArray(sel)){ sel.forEach(o=> books = books.concat(o.books)); }
    else if(sel.books){ books = books.concat(sel.books); }
  });
  return books;
}

function computeMissing(){
  const reqs=document.querySelectorAll('[data-require]');
  let items=[];
  reqs.forEach(sec=>{
    const need=parseInt(sec.dataset.require,10);
    const key=sec.dataset.key;
    const picked=(selections.choices[key]||[]).length;
    const remain=need-picked;
    if(remain>0){
      const title=sec.querySelector('h3')? sec.querySelector('h3').textContent.replace(/（.*?）/,'') : '選択';
      items.push(`${title}: あと${remain}科目`);
    }
  });
  return items;
}

function updatePreview(){
  const list=$('#pv-list'); const cnt=$('#pv-count'); const tot=$('#pv-total');
  list.innerHTML='';
  const books=aggregateBooks(); let total=0;
  books.forEach(b=>{
    const tr=document.createElement('tr');
    const note=b.note?` <span class="warning">${b.note}</span>`:'';
    tr.innerHTML=`<td>${b.n}${note}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`;
    list.appendChild(tr); total+=(b.p||0);
  });
  cnt.textContent=`${books.length} 点`;
  tot.textContent=`¥${total.toLocaleString()}`;
  const missing=computeMissing(); const pv=$('#pv-missing');
  pv.textContent = (missing.length? ('未完了: '+missing.join(' / ')) : 'すべての必須選択が満たされています。');
  $('#btn-final').disabled = missing.length>0;
}

function updateFinalizeState(){ const missing=computeMissing(); $('#btn-final').disabled = missing.length>0; }

function finalize(){
  const missing=computeMissing(); if(missing.length){ alert('未完了の項目があります: '+missing.join(' / ')); return; }
  const listBody=$('#res-list'); listBody.innerHTML='';
  const books=aggregateBooks(); let total=0; let count=0;
  books.forEach(b=>{
    const tr=document.createElement('tr');
    const note=b.note?` <span class="warning">${b.note}</span>`:'';
    tr.innerHTML=`<td>${b.n}${note}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`;
    listBody.appendChild(tr); total+=(b.p||0); count++;
  });
  $('#res-info').textContent = `3年 ${selections.course}コース（${selections.track || '—'}）`;
  $('#res-count').textContent = `${count} 点`;
  $('#res-total').textContent = `¥${total.toLocaleString()}`;
  const today=new Date(); const y=today.getFullYear(), m=('0'+(today.getMonth()+1)).slice(-2), d=('0'+today.getDate()).slice(-2);
  $('#print-meta').textContent = `学年：3年／コース：${selections.course}／進路：${selections.track || '—'}　作成日：${y}-${m}-${d}`;
  $('#print-header').style.display='block';
  goStep('result');
}

function keyNavHandler(e){
  const tgt=e.target; if(!tgt.classList.contains('selector')) return;
  const parent=tgt.parentElement; const btns=[...parent.querySelectorAll('button.selector')];
  const idx=btns.indexOf(tgt);
  if(e.key==='ArrowRight' || e.key==='ArrowDown'){ const n=btns[(idx+1)%btns.length]; n.focus(); e.preventDefault(); }
  if(e.key==='ArrowLeft'  || e.key==='ArrowUp'){ const p=btns[(idx-1+btns.length)%btns.length]; p.focus(); e.preventDefault(); }
  if(e.key==='Enter' || e.key===' '){ tgt.click(); e.preventDefault(); }
}
document.addEventListener('keydown', keyNavHandler, true);

// === 強制フォールバック（コースボタン未生成対策） ===
function __injectCourseButtons(){
  try{
    var box = document.querySelector('#course-btns');
    if(!box){
      var holder = document.querySelector('#step-course .section');
      if(holder){
        box = document.createElement('div');
        box.id='course-btns';
        box.className='btn-grid';
        var actions = holder.querySelector('.actions');
        if(actions){ holder.insertBefore(box, actions); } else { holder.appendChild(box); }
      }
    }
    if(box && box.children.length===0){
      var courses = ['特進','グローバル','メディカルプレップ','総合進学'];
      courses.forEach(function(c){
        var b=document.createElement('button'); b.className='selector'; b.textContent=c+'コース';
        b.setAttribute('role','radio'); b.setAttribute('aria-checked','false');
        b.onclick=function(){ try{ if(typeof markPressed==='function') markPressed(b); if(typeof pickCourse==='function') pickCourse(c); } catch(e){} };
        box.appendChild(b);
      });
    }
    // 強制的にコースステップを可視化
    try{ if(typeof goStep==='function'){ goStep('course'); } }catch(e){}
  }catch(e){}
}

// リトライ（0.7s / 1.5s / 2.5s）
setTimeout(function(){ var box=document.querySelector('#course-btns'); if(!box || box.children.length===0){ __injectCourseButtons(); } }, 700);
setTimeout(function(){ var box=document.querySelector('#course-btns'); if(!box || box.children.length===0){ __injectCourseButtons(); } }, 1500);
setTimeout(function(){ var box=document.querySelector('#course-btns'); if(!box || box.children.length===0){ __injectCourseButtons(); } }, 2500);


setTimeout(function(){
  try{
    var box = document.querySelector('#course-btns');
    if(box && box.children.length===0){ if(typeof buildCourseButtonsForG3==='function') buildCourseButtonsForG3(); if(typeof goStep==='function') goStep('course'); }
  }catch(e){ console.warn('fallback init warn', e); }
}, 800);


setTimeout(function(){
  try{
    var box = document.querySelector('#course-btns');
    if(!box){
      var holder = document.querySelector('#step-course .section');
      if(holder){ box = document.createElement('div'); box.id='course-btns'; box.className='btn-grid'; var actions=holder.querySelector('.actions'); if(actions){ holder.insertBefore(box, actions); } else { holder.appendChild(box); } }
    }
    if(box && box.children.length===0){
      var courses = ['特進','グローバル','メディカルプレップ','総合進学'];
      courses.forEach(function(c){
        var b=document.createElement('button'); b.className='selector'; b.textContent=c+'コース'; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false');
        b.onclick=function(){ try{ if(typeof markPressed==='function') markPressed(b); if(typeof pickCourse==='function') pickCourse(c); else { window.__sel_course=c; if(typeof goStep==='function') goStep('track'); } } catch(e){ console.error(e); } };
        box.appendChild(b);
      });
      if(typeof goStep==='function') goStep('course');
    }
  }catch(e){ console.warn('super-fallback warn', e); }
}, 1500);


function initForGrade3(){
  selections.grade='3';
  selections.course=''; selections.track=''; selections.choices={};
  if(stepEls.grade) stepEls.grade.classList.add('hidden');
  if(pillEls.grade) pillEls.grade.classList.add('hidden');
  buildCourseButtonsForG3();
  goStep('course');
}

function restartG3(){ initForGrade3(); updatePreview(); }

document.addEventListener('DOMContentLoaded', function(){ try{ initForGrade3(); } catch(e){ console.error('Init error', e); alert('初期化エラー: '+e.message); } });

function openVendorSheet(){
 const books = aggregateBooks();
 let total = 0;
 const rows = books.map(b=>{
   const price=(b.p||0); total+=price;
   const note=b.note?` <span class="warning">${b.note}</span>`:'';
   return `<tr><td>${b.n}${note}</td><td class='r'>¥${price.toLocaleString()}</td></tr>`;
 }).join('');
 const ymd = (()=>{ const t=new Date(); const y=t.getFullYear(); const m=('0'+(t.getMonth()+1)).slice(-2); const d=('0'+t.getDate()).slice(-2); return `${y}-${m}-${d}`; })();
 const meta = `学年：3年／コース：${selections.course}／進路：${selections.track||'—'}`;

const selNames = [];
Object.entries(selections.choices).forEach(([k,v])=>{
  if(k && k.startsWith('auto_')) return;
  if(Array.isArray(v)) v.forEach(o=>{ if(o&&o.name) selNames.push(o.name); });
  else if(v && v.name) selNames.push(v.name);
});
const courseLine = selections.course ? `コース：${selections.course}` : 'コース：—';
const trackLine = `進路：${selections.track||'—'}`;
const choicesLine = `選択科目：${selNames.length? selNames.join('、'):'—'}`;
const selectionSummary = `<div class='section'><h2 style="margin:10px 0 6px;color:#0a3a7a;font-size:1.05rem">選択内容</h2>`+
  `<ul style="margin:6px 0 0 18px"><li>${courseLine}</li><li>${trackLine}</li><li>${choicesLine}</li></ul></div>`;

 const win = window.open('', '_blank');
 const html = `<!DOCTYPE html>
<html lang='ja'>
<head>
<meta charset='UTF-8' />
<meta name='viewport' content='width=device-width, initial-scale=1' />
<title>教科書購入表（販売業者提出用）</title>
<style>
 :root{--ink:#1b2330;--muted:#6b7280;--brand:#0a3a7a}
 body{margin:20px;font:14px/1.6 system-ui,-apple-system,Segoe UI,'Hiragino Sans','Yu Gothic',sans-serif;color:var(--ink)}
 h1{font-size:1.3rem;margin:0 0 6px;color:var(--brand)}
 .meta{color:var(--muted);margin-bottom:12px}
 .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px;margin:12px 0}
 .field{display:flex;gap:6px;align-items:center}
 .field label{white-space:nowrap;color:#374151;font-weight:600}
 .field .box{flex:1 1 auto;border:1px solid #e5e7eb;padding:6px 8px;min-height:28px}
 table{width:100%;border-collapse:collapse;margin-top:8px}
 th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px}
 th{background:#f9fbff;text-align:left}
 td.r{text-align:right;white-space:nowrap}
 .tot{display:flex;justify-content:flex-end;gap:10px;margin-top:10px;padding:10px;border-top:2px solid #f3e8c9;background:#fffaf2;font-weight:800}
 .note{font-size:.9rem;color:var(--muted)}
 .flex{display:flex;gap:16px;margin-top:12px}
 .flex .col{flex:1}
 .stamp{height:54px;border:1px dashed #cbd5e1;background:#f8fafc}
 .checks{display:flex;gap:12px;align-items:center}
 .checks label{display:flex;gap:6px;align-items:center}
 @media print{.print-hide{display:none!important}; body{margin:0;padding:20px}}
</style>
</head>
<body>
 <h1>教科書購入表（販売業者提出用）</h1>
 <div class='meta'>${meta} ／ 作成日：${ymd}</div>
  ${selectionSummary}
 <div class='grid'>
   <div class='field'><label>学年・組</label><div class='box'> <select id='fld-class'><option value='' disabled selected>選択</option><option>2年A組</option><option>2年B組</option><option>2年C組</option><option>2年D組</option><option>2年E組</option><option>2年F組</option><option>2年G組</option><option>2年H組</option><option>2年I組</option><option>2年J組</option><option>2年K組</option></select> </div></div>
   <div class='field'><label>番号</label><div class='box'> <select id='fld-no'><option value='' disabled selected>選択</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option><option>24</option><option>25</option><option>26</option><option>27</option><option>28</option><option>29</option><option>30</option><option>31</option><option>32</option><option>33</option><option>34</option><option>35</option><option>36</option><option>37</option><option>38</option><option>39</option><option>40</option><option>41</option><option>42</option><option>43</option><option>44</option><option>45</option></select> </div></div>
   <div class='field'><label>氏名</label><div class='box'> <input id='fld-name' type='text' placeholder='氏名を入力'/> </div></div>
   <div class='field'><label>連絡先</label><div class='box'> </div></div>
 </div>
 <table>
   <thead><tr><th>教材名</th><th class='r'>価格</th></tr></thead>
   <tbody>${rows}</tbody>
 </table>
 <div class='tot'><span>合計金額：</span><strong>¥${total.toLocaleString()}</strong></div>
 <div class='flex'>
   <div class='col'>
     <div class='field'><label>支払方法</label>
       <div class='checks'>
         <label><input type='checkbox' checked/> 現金</label> <label><input type='checkbox' disabled/> 振込</label> <label><input type='checkbox' disabled/> その他</label> </div>
     </div>
     <div class='field' style='margin-top:8px'><label>発注番号</label><div class='box'> </div></div>
   </div>
   <div class='col'>
     <div class='field' style='margin-top:8px'><label>受付印</label><div class='box stamp'> </div></div>
   </div>
 </div>
 <div class='note' style='margin-top:12px'>※ 価格未登録の科目は「¥0（要確認）」として表示されています。販売業者確定価格で精算してください。</div>
 <div class='print-hide' style='margin-top:14px'>
   <button onclick='window.print()' style='padding:8px 12px'>印刷する</button>
 </div>
</body>
</html>`;
 win.document.open(); win.document.write(html); win.document.close();
}
// ---- Safe init guard (added by patch) ----
(function(){
  try {
    if (typeof initForGrade3 === 'function') { initForGrade3(); }
    else if (typeof __injectCourseButtons === 'function') { __injectCourseButtons(); }
    if (typeof goStep === 'function') goStep('course');
  } catch (e) {
    console.error('Init fallback error:', e);
    var box = document.querySelector('#course-btns');
    if (box) { box.innerHTML = '<div style="color:#b00020;font-weight:700">初期化エラー：' + escapeHTML(e && e.message) + '</div>'; }
  }
})();

</script>
</body>
</html>
