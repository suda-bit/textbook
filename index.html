
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>教科書購入シミュレーター｜北海学園札幌（Premium UI・Refined＋学年/コース出し分け強化）</title>
<style>
:root{--brand:#0a3a7a;--brand-2:#0f4c9a;--gold:#d4af37;--bg:#f6f8fc;--panel:#ffffff;--ink:#1b2330;--muted:#6b7280;--ok:#137333;--warn:#b26b00;--err:#b00020;--ring:0 0 0 3px rgba(13,110,253,.25);--shadow:0 10px 30px rgba(10,58,122,.12);--radius:14px}
@media (prefers-color-scheme: dark){:root{--bg:#0f1724;--panel:#0f1b2f;--ink:#e8eefb;--muted:#97a2b9;--shadow:0 12px 28px rgba(0,0,0,.5)}}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(800px 400px at -10% -10%,#e9f1ff,transparent 55%),radial-gradient(900px 400px at 110% 0%,#fff3d6,transparent 55%),linear-gradient(180deg,#ffffff,var(--bg));color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,'Hiragino Sans','Yu Gothic',sans-serif}
.container{max-width:1120px;margin:clamp(10px,3vw,28px) auto;padding:clamp(10px,2vw,20px)}
.visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;padding:0;border:0;clip:rect(0 0 0 0);overflow:hidden}
.app-header{display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,#ffffffb5,#ffffff40);border:1px solid #ffffff70;backdrop-filter:blur(10px);padding:14px 18px;border-radius:16px;box-shadow:var(--shadow);position:sticky;top:10px;z-index:5}
.logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#fff;border:2px solid var(--gold);overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.title{margin:0;font-weight:800;letter-spacing:.02em;color:var(--brand);font-size:clamp(1.15rem,2.2vw,1.6rem)}
.subtitle{margin:0;color:var(--muted);font-size:.9rem}
.stepper{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.step-pill{flex:1 1 160px;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:#fff;border:1px solid #e6ebf5;color:#667085;font-weight:700;box-shadow:0 3px 12px rgba(0,0,0,.05)}
.step-pill .dot{width:24px;height:24px;border-radius:999px;display:grid;place-items:center;background:#eef2f8;color:#304056;font-weight:800;font-size:.9rem}
.step-pill[aria-current="step"]{color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent}
.step-pill[aria-current="step"] .dot{background:#ffffff33;color:#fff}
.step-pill.done{background:#0a3a7a10;color:var(--brand);border-color:#0a3a7a30}
.main{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
@media (max-width:960px){.main{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid #ffffff40;border-radius:var(--radius);box-shadow:var(--shadow)}
.content-panel{padding:clamp(14px,2.2vw,22px)}
.preview-panel{position:sticky;top:86px;align-self:start}
.preview-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e9eef7;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-radius:var(--radius) var(--radius) 0 0}
.preview-body{padding:12px 16px;max-height:70vh;overflow:auto}
.badge{background:#ffffff25;border:1px solid #ffffff55;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.82rem}
.section{margin-bottom:16px}
.section h3{margin:0 0 6px;color:var(--brand)}
.help{color:var(--muted);font-size:.9rem;margin:-2px 0 8px}
.btn-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
button.selector{position:relative;padding:14px;border-radius:12px;border:1px solid #e7ecf6;background:#fff;text-align:left;font-weight:800;color:#2c3446;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease;box-shadow:0 6px 16px rgba(10,58,122,.08)}
button.selector .hint{display:block;font-size:.82rem;color:var(--muted);font-weight:600;margin-top:4px}
button.selector:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(10,58,122,.16),var(--ring)}
button.selector[aria-pressed="true"],button.selector:focus{outline:3px solid #0a3a7a66}
.chk-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.chk{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid #e7ecf6;border-radius:12px;padding:10px}
.chk input{transform:scale(1.2)}
.table{width:100%;border-collapse:collapse;background:#fff}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #eef2f8;font-size:.92rem}
.table th{background:#f9fbff;color:#445;text-align:left}
.table td.r{text-align:right;white-space:nowrap}
.total-row{display:flex;justify-content:flex-end;gap:12px;padding:12px 16px;border-top:2px solid #f2e9c9;background:#fffaf2;color:#7a5600;font-weight:800}
.note{font-size:.88rem;color:var(--muted)}
.warning{color:var(--warn)}
.ok{color:var(--ok)}
.status-pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:.8rem;border:1px solid #e7ecf6;background:#fff}
.status-pill.ok{border-color:#cfe8d8;color:var(--ok);background:#f0fbf4}
.status-pill.warn{border-color:#f1e0c4;color:var(--warn);background:#fff8eb}
.skeleton{position:relative;overflow:hidden;background:#eef2f8}
.skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);animation:shimmer 1.2s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}
.hidden{display:none!important}
.spacer{height:8px}
.actions{display:flex;gap:10px;margin-top:10px}
.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
.primary:disabled{opacity:.6}
.secondary{background:#eef2f8;color:#304056;border:none;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
@media print{.app-header,.stepper,.preview-panel,.actions{display:none!important}.panel{box-shadow:none;border:none}.content-panel{padding:0}#print-header{display:block!important;border-bottom:2px solid #e5e7eb;margin-bottom:12px;padding-bottom:8px}}
#print-header{display:none}
#print-header h2{margin:0 0 4px}
#print-header .meta{font-size:.9rem;color:#4a5568}
</style>
</head>
<body>
<div class="container">
<header class="app-header panel" role="banner">
<div aria-hidden="true" class="logo">./00学園札幌校章カラー.bmp</div>
<div>
<h1 class="title">教科書購入シミュレーター（Premium UI・Refined）</h1>
<p class="subtitle">会計学Ⅰは2年のみ／会計学Ⅱは3年のみ／2年の地歴は3年も継続／特進は学校設定・第二外国語なし</p>
</div>
</header>
<nav aria-label="進行状況" class="stepper">
<div aria-current="step" class="step-pill" id="pill-grade"><span class="dot">1</span>学年</div>
<div class="step-pill" id="pill-course"><span class="dot">2</span>コース</div>
<div class="step-pill" id="pill-track"><span class="dot">3</span>進路</div>
<div class="step-pill" id="pill-elective"><span class="dot">4</span>選択</div>
<div class="step-pill" id="pill-result"><span class="dot">5</span>確認</div>
</nav>
<div class="main">
<main aria-live="polite" class="panel content-panel" id="content">
<div aria-hidden="true" id="print-header">
<h2>教科書購入控え</h2>
<div class="meta" id="print-meta">学年・コース・文理／作成日</div>
</div>
<section aria-labelledby="g-title" class="step" id="step-grade">
<h2 class="visually-hidden" id="g-title">学年</h2>
<div aria-label="学年を選択" class="section" role="radiogroup">
<h3>学年を選択 <span class="status-pill warn" id="st-grade">未選択</span></h3>
<div class="btn-grid">
<button aria-checked="false" aria-pressed="false" class="selector" onclick="pickGrade('1', this)" role="radio">新1年生</button>
<button aria-checked="false" aria-pressed="false" class="selector" onclick="pickGrade('2', this)" role="radio">新2年生</button>
<button aria-checked="false" aria-pressed="false" class="selector" onclick="pickGrade('3', this)" role="radio">新3年生</button>
</div>
</div>
</section>
<section aria-labelledby="c-title" class="step hidden" id="step-course">
<h2 class="visually-hidden" id="c-title">コース</h2>
<div aria-label="コースを選択" class="section" role="radiogroup">
<h3>コースを選択 <span class="status-pill warn" id="st-course">未選択</span></h3>
<div class="btn-grid" id="course-btns"></div>
<div class="actions"><button class="secondary" onclick="goStep('grade')">戻る</button></div>
</div>
</section>
<section aria-labelledby="t-title" class="step hidden" id="step-track">
<h2 class="visually-hidden" id="t-title">進路</h2>
<div aria-label="進路を選択" class="section" role="radiogroup">
<h3>進路（文理）を選択 <span class="status-pill warn" id="st-track">未選択</span></h3>
<div class="btn-grid">
<button aria-checked="false" aria-pressed="false" class="selector" onclick="pickTrack('文系', this)" role="radio">文系</button>
<button aria-checked="false" aria-pressed="false" class="selector" onclick="pickTrack('理系', this)" role="radio">理系</button>
</div>
<div class="actions"><button class="secondary" onclick="goStep('course')">戻る</button></div>
</div>
</section>
<section aria-labelledby="e-title" class="step hidden" id="step-elective">
<h2 class="visually-hidden" id="e-title">選択</h2>
<div class="section skeleton" id="elective-skeleton" style="height:120px;border-radius:12px"></div>
<div aria-live="polite" class="hidden" id="elective-sections"></div>
<div class="actions">
<button class="secondary" onclick="goStep('track')">戻る</button>
<button class="primary" disabled="" id="btn-final" onclick="finalize()">選択を確定して結果へ</button>
</div>
</section>
<section aria-labelledby="r-title" class="step hidden" id="step-result">
<h2 class="visually-hidden" id="r-title">結果</h2>
<div class="section">
<h3>結果 <span class="status-pill ok" id="st-result">作成済み</span></h3>
<div class="note">必修・選択を合算しています。価格未登録は¥0（※要確認）で表示します。</div>
<div class="spacer"></div>
<div class="panel">
<div class="preview-header">
<div id="res-info">集計</div>
<span class="badge" id="res-count">0 点</span>
</div>
<div class="preview-body">
<table class="table">
<thead><tr><th>教材名</th><th class="r">定価</th></tr></thead>
<tbody id="res-list"></tbody>
</table>
<div class="total-row"><span>合計金額:</span><strong id="res-total">¥0</strong></div>
</div>
</div>
<div class="actions"><button class="primary" id="btn-vendor" onclick="openVendorSheet()">教科書購入表を表示</button><button class="secondary" onclick="location.reload()">最初に戻る</button></div>
</div>
</section>
</main>
<aside aria-label="選択状況サマリー" class="panel preview-panel">
<div class="preview-header"><strong>選択状況</strong><span class="badge" id="pv-count">0 点</span></div>
<div class="preview-body">
<div class="note">価格未登録は ¥0（※要確認）として表示します。</div>
<div class="spacer"></div>
<table class="table">
<thead><tr><th>教材名</th><th class="r">概算</th></tr></thead>
<tbody id="pv-list"></tbody>
</table>
<div class="total-row"><span>概算合計:</span><strong id="pv-total">¥0</strong></div>
<div class="spacer"></div>
<div class="note warning" id="pv-missing">必須の選択数を満たしていない項目があります。</div>
</div>
</aside>
</div>
</div>
<div aria-live="polite" class="visually-hidden" id="live-region"></div>
<script>
const selections = { grade:'', course:'', track:'', choices:{} };
const $ = s => document.querySelector(s);
const stepEls = { grade:$('#step-grade'), course:$('#step-course'), track:$('#step-track'), elective:$('#step-elective'), result:$('#step-result') };
const pillEls = { grade:$('#pill-grade'), course:$('#pill-course'), track:$('#pill-track'), elective:$('#pill-elective'), result:$('#pill-result') };
const statusEls = { grade:$('#st-grade'), course:$('#st-course'), track:$('#st-track') };
function setStepper(state){ for(const k in pillEls){ const p=pillEls[k]; p.removeAttribute('aria-current'); p.classList.toggle('done', false);} pillEls[state].setAttribute('aria-current','step'); const order=['grade','course','track','elective','result']; for(const k of order){ if(k===state) break; pillEls[k].classList.add('done'); } }
function goStep(id){ Object.entries(stepEls).forEach(([k,el])=>{ if('step-'+id===el.id) el.classList.remove('hidden'); else el.classList.add('hidden'); }); setStepper(id); updatePreview();
  // HIDE_PREVIEW_ON_RESULT
  try { var aside = document.querySelector('.preview-panel'); if (aside) { aside.classList.toggle('hidden', id==='result'); } } catch(e){}
  announce(`ステップを${id}に移動しました。`); }
function announce(msg){ const live=$('#live-region'); if(!live) return; live.textContent=''; setTimeout(()=> live.textContent=msg, 10); }

const baseDB = {
  '1': { common: [
    {n:"精選 現代の国語", p:625},{n:"精選 言語文化", p:780},{n:"新地理総合", p:747},
    {n:"新詳高等地図", p:1561},{n:"明解 歴史総合", p:768},{n:"数学I Standard", p:824},
    {n:"数学A Standard", p:653},{n:"数学II Standard", p:867},{n:"新編 物理基礎", p:877},
    {n:"新化学基礎", p:880},{n:"生物基礎", p:996},{n:"最新高等保健体育", p:913},
    {n:"Vivid English Comm I", p:701},{n:"Logic & Expression I", p:633},
    {n:"最新地理図表 GEO", p:1034},{n:"歴史総合ノート", p:710},{n:"ターゲット1400", p:1210},
    {n:"物理基礎サポートノート", p:638},{n:"化学基礎ネオパールノート", p:649}
  ], arts: [ {group:'芸術（1科目）', options:[
    {name:'音楽I', books:[{n:'新訂 音楽I', p:742},{n:'音楽ノート', p:350}]},
    {name:'美術I', books:[{n:'高校美術1', p:928}]}
  ]} ] },
  '2': { common: [
    {n:"精選 論理国語", p:930},{n:"文学国語", p:993},{n:"古典探究(古文)", p:661},
    {n:"古典探究(漢文)", p:412},{n:"公共", p:721},{n:"数学C Standard", p:714},
    {n:"Vivid English Comm II", p:729},{n:"Logic & Expression II", p:642},
    {n:"最新情報I", p:1072},{n:"数学C ワークWIDE", p:550},{n:"情報I学習ノート", p:670}
  ], geoHist: [ {group:'地歴・公民（1科目）', options:[
    {name:'日本史探究', books:[{n:'詳説 日本史', p:941},{n:'日本史ノート', p:850}]},
    {name:'世界史探究', books:[{n:'詳説 世界史', p:941},{n:'世界史ノート', p:850}]},
    {name:'地理探究', books:[{n:'詳説 地理探究', p:1053}]}
  ]} ] },
  '3': { common: [
    {n:"数学B Standard", p:759},{n:"Vivid English Comm III", p:706},
    {n:"Logic & Expression III", p:542},{n:"数学B ワークWIDE", p:490}
  ] }
};

const curriculum = {
  symbolsInfo: '※ 同じ記号（■, △, □ など）の中から各1科目選択できる場合があります。',
  schoolSet: [
    { symbol:'■', group:'学校設定教科（■）', options:[
      {name:'会計学I', books:[{n:'【教材未登録】会計学I', p:0, note:'※要確認'}]},
      {name:'MESE講座', books:[{n:'【教材未登録】MESE講座', p:0, note:'※要確認'}]},
      {name:'英語基礎探究', books:[{n:'【教材未登録】英語基礎探究', p:0, note:'※要確認'}]},
      {name:'プレゼンテーション', books:[{n:'【教材未登録】プレゼンテーション', p:0, note:'※要確認'}]},
      {name:'プログラミング', books:[{n:'【教材未登録】プログラミング', p:0, note:'※要確認'}]}
    ]},
    { symbol:'△', group:'学校設定教科（△）', options:[
      {name:'会計学II', books:[{n:'【教材未登録】会計学II', p:0, note:'※要確認'}]},
      {name:'ライフプランニング', books:[{n:'【教材未登録】ライフプランニング', p:0, note:'※要確認'}]},
      {name:'医療情報基礎', books:[{n:'【教材未登録】医療情報基礎', p:0, note:'※要確認'}]}
    ]},
    { symbol:'□', group:'第二外国語（□）', options:[
      {name:'中国語', books:[{n:'【教材未登録】中国語', p:0, note:'※要確認'}]},
      {name:'韓国語', books:[{n:'【教材未登録】韓国語', p:0, note:'※要確認'}]}
    ]}
  ],
  civics3: { group: '公民（1科目）', options:[
    { name:'政治・経済', books:[{n:'政治・経済', p:850}] },
    { name:'倫理', books:[{n:'【教材未登録】倫理', p:0, note:'※要確認'}] }
  ]},
  science: {
    grade2: {
      文系: { type:'auto', add:[{n:'化学探究', p:0, note:'※要確認'},{n:'生物探究', p:0, note:'※要確認'}] },
      理系: { type:'single', group:'理科（1科目）', options:[
        {name:'物理', books:[{n:'物理', p:1200}]},
        {name:'化学', books:[{n:'化学', p:1150}]},
        {name:'生物', books:[{n:'生物', p:1100}]}
      ]}
    },
    grade3: {
      文系: { type:'multi', require:2, group:'文系選択（2科目）', options:[
        {name:'国語表現演習', books:[{n:'論理力ワークノート', p:506}]},
        {name:'化学探究', books:[{n:'【教材未登録】化学探究', p:0, note:'※要確認'}]},
        {name:'生物探究', books:[{n:'【教材未登録】生物探究', p:0, note:'※要確認'}]}
      ]},
      理系: { type:'auto', add:[{n:'化学', p:1150}] }
    }
  }
};

function markPressed(btn){ if(!btn) return; const sibs=btn.parentElement.querySelectorAll('button.selector'); sibs.forEach(b=>{b.setAttribute('aria-pressed','false'); b.setAttribute('aria-checked','false');}); btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-checked','true'); }
function pickGrade(g, btn){ selections.grade=g; selections.track=''; selections.choices={}; markPressed(btn); statusEls.grade.className='status-pill ok'; statusEls.grade.textContent='選択済み'; const courses=(g==='1')? ['特進','総合進学'] : ['特進','グローバル','メディカルプレップ','総合進学']; const box=$('#course-btns'); box.innerHTML=''; courses.forEach(c=>{ const b=document.createElement('button'); b.className='selector'; b.textContent=`${c}コース`; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false'); b.onclick=()=>{ markPressed(b); pickCourse(c); }; box.appendChild(b); }); goStep('course'); }
function pickCourse(c){ selections.course=c; selections.choices={}; statusEls.course.className='status-pill ok'; statusEls.course.textContent='選択済み'; const needTrack=(selections.grade!=='1')&&(selections.course!=='特進'); if(needTrack){ goStep('track'); } else { buildElectives(); goStep('elective'); } }
function pickTrack(t, btn){ selections.track=t; markPressed(btn); statusEls.track.className='status-pill ok'; statusEls.track.textContent='選択済み'; buildElectives(); goStep('elective'); }

function section(title){ const wrap=document.createElement('div'); wrap.className='section'; const h=document.createElement('h3'); h.textContent=title; wrap.appendChild(h); return wrap; }
function help(text){ const d=document.createElement('div'); d.className='help'; d.textContent=text; return d; }

function makeSingleChoiceSection(title, options, key){ const sec=section(title); const list=document.createElement('div'); list.className='btn-grid'; const badge=document.createElement('span'); badge.className='status-pill warn'; badge.textContent='未選択'; sec.querySelector('h3').appendChild(document.createTextNode(' ')); sec.querySelector('h3').appendChild(badge); options.forEach(opt=>{ const b=document.createElement('button'); b.className='selector'; b.innerHTML=`${opt.name} <span class='hint'>${opt.books.length}冊</span>`; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false'); b.onclick=()=>{ selections.choices[key]=opt; list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false'); x.setAttribute('aria-checked','false');}); b.setAttribute('aria-pressed','true'); b.setAttribute('aria-checked','true'); badge.className='status-pill ok'; badge.textContent='選択済み'; updatePreview(); updateFinalizeState(); }; list.appendChild(b); }); sec.appendChild(list); return sec; }

function makeMultiChoiceSection(title, options, key, requireCount){ const sec=section(`${title}（${requireCount}科目選択）`); const grid=document.createElement('div'); grid.className='chk-grid'; selections.choices[key]=selections.choices[key]||[]; const badge=document.createElement('span'); badge.className='status-pill warn'; badge.textContent=`あと${requireCount}科目`; sec.querySelector('h3').appendChild(document.createTextNode(' ')); sec.querySelector('h3').appendChild(badge); function updateBadge(){ const picked=(selections.choices[key]||[]).length; const remain=requireCount-picked; if(remain<=0){ badge.className='status-pill ok'; badge.textContent='要件クリア'; } else { badge.className='status-pill warn'; badge.textContent=`あと${remain}科目`; } updatePreview(); updateFinalizeState(); } options.forEach(opt=>{ const row=document.createElement('label'); row.className='chk'; const cb=document.createElement('input'); cb.type='checkbox'; cb.onchange=()=>{ const arr=selections.choices[key]; if(cb.checked){ if(!arr.find(o=>o.name===opt.name)) arr.push(opt);} else { const i=arr.findIndex(o=>o.name===opt.name); if(i>=0) arr.splice(i,1);} updateBadge(); }; const span=document.createElement('span'); span.textContent=`${opt.name}（${opt.books.length}冊）`; row.appendChild(cb); row.appendChild(span); grid.appendChild(row); }); sec.appendChild(grid); sec.dataset.require=requireCount; sec.dataset.key=key; return sec; }

function makeOptionalSingleChoice(title, options, key){ const sec=section(title+'（任意）'); const list=document.createElement('div'); list.className='btn-grid'; const badge=document.createElement('span'); badge.className='status-pill ok'; badge.textContent='任意'; sec.querySelector('h3').appendChild(document.createTextNode(' ')); sec.querySelector('h3').appendChild(badge); const skip=document.createElement('button'); skip.className='selector'; skip.textContent='選択しない（スキップ）'; skip.onclick=()=>{ selections.choices[key]=null; list.querySelectorAll('button').forEach(x=>x.setAttribute('aria-pressed','false')); skip.setAttribute('aria-pressed','true'); updatePreview(); }; list.appendChild(skip); options.forEach(opt=>{ const b=document.createElement('button'); b.className='selector'; b.innerHTML=`${opt.name} <span class='hint'>${opt.books.length}冊</span>`; b.onclick=()=>{ selections.choices[key]=opt; list.querySelectorAll('button').forEach(x=>x.setAttribute('aria-pressed','false')); b.setAttribute('aria-pressed','true'); updatePreview(); }; list.appendChild(b); }); sec.appendChild(list); return sec; }

function autoAddSection(title, books){ const sec=section(title); sec.appendChild(help('自動的に合計へ含まれます。')); const table=document.createElement('table'); table.className='table'; const tb=document.createElement('tbody'); books.forEach(b=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${b.n}${b.note? ' <span class=\'warning\'>'+b.note+'</span>':''}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`; tb.appendChild(tr); }); table.appendChild(tb); sec.appendChild(table); selections.choices['auto_'+title]={name:title, books:books}; return sec; }

function buildElectives(){ $('#elective-skeleton').classList.remove('hidden'); $('#elective-sections').classList.add('hidden'); setTimeout(()=>{ const holder=$('#elective-sections'); holder.innerHTML=''; const g=selections.grade; const course=selections.course; if(g==='2' || g==='3'){ const must=section('必修（自動追加）'); must.appendChild(help('この学年で全員が購入する教科書です。結果にも自動で含まれます。')); const table=document.createElement('table'); table.className='table'; const tb=document.createElement('tbody'); (baseDB[g].common||[]).forEach(b=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${b.n}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`; tb.appendChild(tr); }); table.appendChild(tb); must.appendChild(table); holder.appendChild(must); }
  if(g==='1'){ baseDB['1'].arts.forEach(gr=> holder.appendChild(makeSingleChoiceSection(gr.group, gr.options, 'arts')) ); }
  if(g==='2'){ baseDB['2'].geoHist.forEach(gr=> holder.appendChild(makeSingleChoiceSection(gr.group, gr.options, 'geoHist')) ); }
  if(g==='3'){
    // 2年の地歴は3年も継続：継続科目の選択（注意書き付き）
    const ghOptions = baseDB['2'].geoHist[0].options; // 日本史・世界史・地理
    const cont = makeSingleChoiceSection('地歴（2年の継続・1科目）', ghOptions, 'geoHist3_cont');
    cont.insertBefore(help('※2年で選択した科目と同じものを選択してください'), cont.children[1] || null);
    holder.appendChild(cont);
    // 既存の文系/理系分岐と公民
    if(course!=='特進' && selections.track==='文系'){
      const sc=curriculum.science.grade3.文系; // 3年文系ルール：国語表現演習（必修）+ 生物探究/化学探究から1
 const jp = sc.options.find(o=>o.name==='国語表現演習');
 const sciOnly = sc.options.filter(o=> o.name==='生物探究' || o.name==='化学探究');
 if(jp) holder.appendChild(autoAddSection('国語表現演習（必修）', jp.books));
 holder.appendChild(makeRequiredSingleFromOptions('文系理科選択', sciOnly, 'g3libSci'));
      const civ=curriculum.civics3; holder.appendChild(makeSingleChoiceSection(civ.group, civ.options, 'civ3'));
    } else {
      const civ=curriculum.civics3; holder.appendChild(makeSingleChoiceSection(civ.group, civ.options, 'civ3'));
      if(course!=='特進' && selections.track==='理系'){
        const auto=curriculum.science.grade3.理系; holder.appendChild(autoAddSection('理科（理系は化学必修）', auto.add));
 const pick3 = [{name:'物理', books:[{n:'物理', p:1200}]}, {name:'生物', books:[{n:'生物', p:1100}]}];
 holder.appendChild(makeRequiredSingleFromOptions('理系理科選択', pick3, 'sci3_pick'));
      }
    }
  }
  if(g==='2'){
    if(selections.track==='理系'){ const sc=curriculum.science.grade2.理系; holder.appendChild(makeSingleChoiceSection(sc.group, sc.options, 'sci2')); }
    else { const auto=curriculum.science.grade2.文系; holder.appendChild(autoAddSection('理科（文系は探究2科必修）', auto.add)); }
  }
  // 学校設定：1年は非表示、かつ「特進」には設置しない
  if(g!=='1' && course!=='特進'){
    const block=section('学校設定教科（カリキュラム表に基づくシンボル選択）'); block.appendChild(help(curriculum.symbolsInfo)); let added=0;
    curriculum.schoolSet.forEach((grp, idx)=>{ let opts=grp.options.slice();
      // □ ブロックをスキップ（第二外国語は廃止）
      if(grp.symbol==='□'){ return; }
        // 3年生にはMESEは開講しないため非表示
        // 英語基礎探究は3年非表示
        if(g==='3'){ opts = opts.filter(o=> o.name !== '英語基礎探究'); }
        if(g==='3'){ opts = opts.filter(o=> o.name !== 'MESE講座'); }
      // □ 第二外国語：韓国語はグローバルのみ
      if(grp.symbol==='□' && course!=='グローバル'){ opts = opts.filter(o=> o.name !== '韓国語'); }
      // △ に中国語を追加
      if(grp.symbol==='△'){ opts = opts.concat([{name:'中国語', books:[{n:'【教材未登録】中国語', p:0, note:'※要確認'}]}]); }
      // △ 医療情報基礎：メディカルプレップのみ表示
      if(grp.symbol==='△' && course!=='メディカルプレップ'){ opts = opts.filter(o=> o.name !== '医療情報基礎'); }
      // ■ 会計学I：2年のみ表示
      if(grp.symbol==='■' && g!=='2'){ opts = opts.filter(o=> o.name !== '会計学I'); }
      // △ 会計学II：3年のみ表示
      if(grp.symbol==='△' && g!=='3'){ opts = opts.filter(o=> o.name !== '会計学II'); }
      if(opts.length>0){ block.appendChild(makeOptionalSingleChoice(`${grp.group}`, opts, `ss_${idx}`)); added++; }
    }); if(added>0) holder.appendChild(block);
  }
  updatePreview(); updateFinalizeState(); $('#elective-skeleton').classList.add('hidden'); holder.classList.remove('hidden'); }, 450); }

function aggregateBooks(){ const g=selections.grade; let books=[]; if(!g) return []; books = books.concat(baseDB[g].common || []); if(selections.course==='特進'){ books.push({n:'特進専用 共テ対策問題集', p:1060}); if(g==='1') books.push({n:'数学WIDE I+A解答', p:270}); } Object.values(selections.choices).forEach(sel=>{ if(!sel) return; if(Array.isArray(sel)){ sel.forEach(o=> books = books.concat(o.books)); } else if(sel.books){ books = books.concat(sel.books); } }); return books; }

function computeMissing(){ const reqs=document.querySelectorAll('[data-require]'); let items=[]; reqs.forEach(sec=>{ const need=parseInt(sec.dataset.require,10); const key=sec.dataset.key; const picked=(selections.choices[key]||[]).length; const remain=need-picked; if(remain>0){ const title=sec.querySelector('h3')? sec.querySelector('h3').textContent.replace(/（.*?）/,'') : '選択'; items.push(`${title}: あと${remain}科目`); } }); return items; }

function updatePreview(){ const list=$('#pv-list'); const cnt=$('#pv-count'); const tot=$('#pv-total'); list.innerHTML=''; const books=aggregateBooks(); let total=0; books.forEach(b=>{ const tr=document.createElement('tr'); const note=b.note?` <span class='warning'>${b.note}</span>`:''; tr.innerHTML=`<td>${b.n}${note}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`; list.appendChild(tr); total+=(b.p||0); }); cnt.textContent=`${books.length} 点`; tot.textContent=`¥${total.toLocaleString()}`; const missing=computeMissing(); const pv=$('#pv-missing'); pv.textContent = (missing.length? ('未完了: '+missing.join(' / ')) : 'すべての必須選択が満たされています。'); $('#btn-final').disabled = missing.length>0; }

function updateFinalizeState(){ const missing=computeMissing(); $('#btn-final').disabled = missing.length>0; }

function finalize(){ const missing=computeMissing(); if(missing.length){ alert('未完了の項目があります: '+missing.join(' / ')); return; } const listBody=$('#res-list'); listBody.innerHTML=''; const books=aggregateBooks(); let total=0; let count=0; books.forEach(b=>{ const tr=document.createElement('tr'); const note=b.note?` <span class='warning'>${b.note}</span>`:''; tr.innerHTML=`<td>${b.n}${note}</td><td class='r'>¥${(b.p||0).toLocaleString()}</td>`; listBody.appendChild(tr); total+=(b.p||0); count++; }); $('#res-info').textContent = `${selections.grade}年 ${selections.course}コース（${selections.track || '—'}）`; $('#res-count').textContent = `${count} 点`; $('#res-total').textContent = `¥${total.toLocaleString()}`; const today=new Date(); const y=today.getFullYear(), m=('0'+(today.getMonth()+1)).slice(-2), d=('0'+today.getDate()).slice(-2); $('#print-meta').textContent = `学年：${selections.grade}年／コース：${selections.course}／進路：${selections.track || '—'}\u3000作成日：${y}-${m}-${d}`; $('#print-header').style.display='block'; goStep('result'); }

function keyNavHandler(e){ const tgt=e.target; if(!tgt.classList.contains('selector')) return; const parent=tgt.parentElement; const btns=[...parent.querySelectorAll('button.selector')]; const idx=btns.indexOf(tgt); if(e.key==='ArrowRight' || e.key==='ArrowDown'){ const n=btns[(idx+1)%btns.length]; n.focus(); e.preventDefault(); } if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ const p=btns[(idx-1+btns.length)%btns.length]; p.focus(); e.preventDefault(); } if(e.key==='Enter' || e.key===' '){ tgt.click(); e.preventDefault(); } }
document.addEventListener('keydown', keyNavHandler, true);

(function init(){ goStep('grade'); })();


function openVendorSheet(){
  const books = aggregateBooks();
  let total = 0;
  const rows = books.map(b=>{ const price=(b.p||0); total+=price; const note=b.note?` <span class='warning'>${b.note}</span>`:''; return `<tr><td>${b.n}${note}</td><td class='r'>¥${price.toLocaleString()}</td></tr>`; }).join('');
  const ymd = (()=>{ const t=new Date(); const y=t.getFullYear(); const m=('0'+(t.getMonth()+1)).slice(-2); const d=('0'+t.getDate()).slice(-2); return `${y}-${m}-${d}`; })();
  const meta = `学年：${selections.grade}年／コース：${selections.course}／進路：${selections.track||'—'}`;
  const win = window.open('', '_blank');
  const html = `<!DOCTYPE html>
<html lang='ja'>
<head>
<meta charset='UTF-8' />
<meta name='viewport' content='width=device-width, initial-scale=1' />
<title>教科書購入表（販売業者提出用）</title>
<style>
  :root{--ink:#1b2330;--muted:#6b7280;--brand:#0a3a7a}
  body{margin:20px;font:14px/1.6 system-ui,-apple-system,Segoe UI,'Hiragino Sans','Yu Gothic',sans-serif;color:var(--ink)}
  h1{font-size:1.3rem;margin:0 0 6px;color:var(--brand)}
  .meta{color:var(--muted);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px;margin:12px 0}
  .field{display:flex;gap:6px;align-items:center}
  .field label{white-space:nowrap;color:#374151;font-weight:600}
  .field .box{flex:1 1 auto;border:1px solid #e5e7eb;padding:6px 8px;min-height:28px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px}
  th{background:#f9fbff;text-align:left}
  td.r{text-align:right;white-space:nowrap}
  .tot{display:flex;justify-content:flex-end;gap:10px;margin-top:10px;padding:10px;border-top:2px solid #f3e8c9;background:#fffaf2;font-weight:800}
  .note{font-size:.9rem;color:var(--muted)}
  .flex{display:flex;gap:16px;margin-top:12px}
  .flex .col{flex:1}
  .stamp{height:54px;border:1px dashed #cbd5e1;background:#f8fafc}
  .checks{display:flex;gap:12px;align-items:center}
  .checks label{display:flex;gap:6px;align-items:center}
  @media print{.print-hide{display:none!important}; body{margin:0;padding:20px}}
</style>
</head>
<body>
  <h1>教科書購入表（販売業者提出用）</h1>
  <div class='meta'>${meta} ／ 作成日：${ymd}</div>

  <div class='grid'>
    <div class='field'><label>学年・組</label><div class='box'>&nbsp;</div></div>
    <div class='field'><label>番号</label><div class='box'>&nbsp;</div></div>
    <div class='field'><label>出席番号</label><div class='box'>&nbsp;</div></div>
    <div class='field'><label>氏名</label><div class='box'>&nbsp;</div></div>
    <div class='field'><label>連絡先</label><div class='box'>&nbsp;</div></div>
  </div>

  <table>
    <thead><tr><th>教材名</th><th class='r'>価格</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
  <div class='tot'><span>合計金額：</span><strong>¥${total.toLocaleString()}</strong></div>

  <div class='flex'>
    <div class='col'>
      <div class='field'><label>支払方法</label>
        <div class='checks'>
          <label><input type='checkbox'/> 現金</label>
          <label><input type='checkbox'/> 振込</label>
          <label><input type='checkbox'/> その他</label>
        </div>
      </div>
      <div class='field' style='margin-top:8px'><label>発注番号</label><div class='box'>&nbsp;</div></div>
    </div>
    <div class='col'>
      <div class='field'><label>保護者署名</label><div class='box'>&nbsp;</div></div>
      <div class='field' style='margin-top:8px'><label>受付印</label><div class='box stamp'>&nbsp;</div></div>
    </div>
  </div>

  <div class='note' style='margin-top:12px'>※ 価格未登録の科目は「¥0（要確認）」として表示されています。販売業者確定価格で精算してください。</div>

  <div class='print-hide' style='margin-top:14px'>
    <button onclick='window.print()' style='padding:8px 12px'>印刷する</button>
  </div>
</body>
</html>`;
  win.document.open();
  win.document.write(html);
  win.document.close();
}

function makeRequiredSingleFromOptions(title, options, key){
  const sec = section(title + '（1科目）');
  const list = document.createElement('div');
  list.className = 'btn-grid';
  const badge = document.createElement('span');
  badge.className='status-pill warn';
  badge.textContent='未選択';
  sec.querySelector('h3').appendChild(document.createTextNode(' '));
  sec.querySelector('h3').appendChild(badge);
  selections.choices[key] = [];
  options.forEach(opt=>{
    const b = document.createElement('button');
    b.className='selector';
    b.innerHTML = `${opt.name} <span class='hint'>${opt.books.length}冊</span>`;
    b.setAttribute('role','radio');
    b.setAttribute('aria-checked','false');
    b.onclick = ()=>{
      selections.choices[key] = [opt];
      list.querySelectorAll('button').forEach(x=>{x.setAttribute('aria-pressed','false');x.setAttribute('aria-checked','false');});
      b.setAttribute('aria-pressed','true');
      b.setAttribute('aria-checked','true');
      badge.className='status-pill ok';
      badge.textContent='選択済み';
      updatePreview();
      updateFinalizeState();
    };
    list.appendChild(b);
  });
  sec.appendChild(list);
  sec.dataset.require = 1;
  sec.dataset.key = key;
  return sec;
}
</script>
</body>
</html>
